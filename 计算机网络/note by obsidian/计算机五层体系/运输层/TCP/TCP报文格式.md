#TCP #运输层 #笔记 #TCP报文首部 #格式

## TCP报文

网上找的图
![[image-20221016155052673.jpeg]]

总体分为
- **端口号**：用来标识同一台计算机的不同的应用进程
	- **源端口**：标识报文的返回地址
	- **目的端口**：指明接收方计算机上的应用程序接口
	- *TCP报头中的源端口号和目的端口号同IP数据报中的源IP与目的IP唯一确定一条TCP连接。*
- **序号与确认号**：TCP可靠传输的关键部分。
	- **序号**是本报文段发送的数据组的第一个字节的序号。（因为数据发送时是无序的，序号是为了在接收方接受数据后对数据进行组合所采取的。e.g.一个报文段的序号为300，此报文段数据部分共有100字节，则下一个报文段的序号为400。*保证了TCP传输的有序性*）
	- **确认号(ack)**：即ack。指明*下一个期待收到的字节序号*，表示该序号之前的所有数据都已经正确无误的收到。（当且仅当ACK=1时表明有效。比如建立连接时三次握手，SYN报文ACK=0）
- **数据偏移/首部长度**：用以标识TCP报文中可选部分的*偏移*。（当报文中不含有任何可选字段，长20字节，报文最大长度为60字节）（这里的偏移具体数值指的是数据段所在的偏移，即报文头部有多长，计算方式为$$偏移 = Offset*(32(单个可选头)*8)$$单位为字节，范围应该在$\geq20和\leq60$之间）
- **保留**：置零，为以后使用（也没见用。。。。）
- **特殊标志位**（均为1bit）：
	- **紧急URG**：它告诉系统此报文段中有紧急数据，应尽快发送（相当于高优先级的数据），而不要按原来的排队顺序来传送。
	- **确认ACK**：当ACK=1时，该报文有效（准确来说，应该是此时ack字段有效，告知接收方其已经收到上次接收方发送来的报文；提醒接收方检查ack字段，告知所接收报文的最大序号）。（TCP规定，在连接建立后所有的传送的报文段都必须把ACK置为1。利用这个，可以检查报文是否有效。）
	- **推送PSH**：接收方TCP收到PSH=1的报文段，就尽快地（即“推送”向前）交付接收应用进程。而不用再等到整个缓存都填满了后再向上交付。（即发送方希望接收方能够立即反馈该报文）
	- **复位RST**：1.（发送）当RST=1时，表名TCP连接中出现了严重错误（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立传输连接。2.（接收）RST置为1还用来拒绝一个非法的报文段或拒绝打开一个连接。
	- **同步SYN**：建立连接时用来同步序号：该标志位仅在三次握手时生效，提示接收方检查该报文中的序列编号。（仅用作建立连接时同步序号）
	- **终止FIN**：用来要求释放连接。
- **接受窗口**：TCP流量控制所使用。一个用以限定的值，表示自己（发送或接受）这一方从确认号算起可以接受的对方发来的最大数据量（以字节为单位）。（如：发送了一个报文段，其确认号是701，窗口字段是1000.这就是告诉对方：“从701算起，我（即发送报文段的一方）的接收缓存空间还可接受1000个字节数据（字节序号是701~1700），你在给我发数据时，必须考虑到这一点。”）
- **检验和**：要检验的部分包括首部和数据两部分。计算检验和时，要在TCP报文段前面加上12字节的伪首部。
- **紧急数据指针**：仅在URG=1时才生效。指出本报文段中紧急字节数计算方式为$$紧急数据末尾=序号+紧急数据指针$$
- **选项**：长度可变，最长达40字节。每个选项长度为4的倍数，因此在某些情况下需要NOP填充。
- **数据**：报文数据部分。

## 补充

### 报文序号问题

$$ack=发送序号+数据长度+1$$
即ACK表示的是希望下一次收到的序号，而不是这次报文的最后序号，需要注意。