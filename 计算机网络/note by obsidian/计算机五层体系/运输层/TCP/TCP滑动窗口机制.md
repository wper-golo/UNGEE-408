利用滑动窗口机制，可以实现TCP的流量控制和可靠传输

## 流量控制

![[image-20221219144957536.png]]

在建立了TCP连接的基础上，A要给B发送数据，假如B的带宽很小，无法接受这么大流量的数据，那么B就得对A控制流量。
- 起始序号为1的数据段发送成功，起始序号为101的数据段也发送成功
- 起始序号为201的数据段发送过程中丢失，B没有收到
- B向A发送ACK报文段，表示收到的下一个序号应该是201
![[image-20221219145447337.png]]
- B发送给A的ACK确认报文段使A调整接受窗口为300，进行**流量控制**
- A的滑动窗口被**调整为3**，其机制使窗口向前滑动两个（有一个没传成功）
- 继续发送301-500的两个报文段，完成后再重传之前没传的数据。这里是只负责传输滑动窗口中的报文段
- B接受数据，回传ACK报文段表示接收到
![[image-20221219150046239.png]]
- B的ACK报文段让A的滑动窗口大小再次调整，变为100
- 滑动窗口继续滑动，这次只能传501-600，因为窗口大小仅为100
- B接收到501-600报文段之后，返回ACK报文段，调整A滑动窗口为0，不再发送

## 可靠传输

![[image-20221219223947875.png]]
![[image-20221219223957952.png]]
>窗口的滑动是根据收到的ACK报文段确认的
>可以看成三个指针
>P1  由返回的ACK报文段决定，根据ACK确认收到的序号会前移
>P2  由发送和返回的ACK报文段决定，表示发送了但还没收到回复的
>P3  由返回的ACK报文段决定，根据rwnd更改窗口大小

## 总结

滑动窗口机制，本质就是利用接收方会回传ACK报文段进行确认，让接收方在其中加入对发送方即将发送的数据的大小控制信息，以此实现流量控制，同时，ACK报文段又能确保传输的可靠性。

## 补充

- 对于不按序到达的数据如何处理？
	- TCP没有明确规定
	- 一般来说，接收方会先存放在缓存区，等正确顺序后再移交上层处理
- TCP是双全工，注意每一方都可以是发送方和接收方，都有接收窗口和发送窗口
- TCP要求接收方必须由累计确认和捎带确认机制，可以减小传输开销。
	- 接收方可以在合适的时候发送确认，也可以在自己数据要发送的时候顺便把确认信息捎带上
	- 接收方不应过分推迟发送确认，否则会导致不必要的超时重传
	- TCP标准规定（RFC 1122）确认推迟的时间不应超过0.5秒。若收到一连串具有最大长度的报文段，则必须每隔一个报文段就发送一个确认。
- 发送方的发送窗口并不是总是和接收方的接收窗口一样大。
	- 网络传送窗口值需要经历一定的时间，时间还不确认，所以某个时刻不一定大小
	- 发送方的发送窗口还有可能根据网络拥塞程度而改变大小。


