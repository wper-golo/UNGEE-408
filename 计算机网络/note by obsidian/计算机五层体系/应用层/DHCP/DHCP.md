## 问题解决

一个网络内的主机，要想对Web服务器进行访问，必须首先手动配置网络相关配置信息，比如IP地址、子网掩码、默认网关、DNS什么的
![[image-20221229112205647.png]]

特别是当网络内主机数目很多时，工作量大，极易出错
为了实现自动化分配，省去手动配置的麻烦，DHCP应运而生
方式为在网络中添加一台DHCP服务器
![[image-20221229112442507.png]]

## 工作过程

**DHCP 工作方式**

-   DHCP 使用客户-服务器方式，采用请求/应答方式工作。
-   DHCP 基于 UDP 工作（DHCP报文在运输层会被封装成为UDP用户数据报），DHCP 服务器运行在 67 号端口， DHCP客户端运行在 68 号端口。

**DHCP 使用客户 - 服务器过程**

-   需要 IP 地址的主机在启动时就向 DHCP 服务器广播发送发现报文 （DHCP DISCOVER），这时该主机就成为 DHCP 客户。
-   本地网络上所有主机都能收到此广播报文，但只有 DHCP 服务器才回答此广播报文。
-   DHCP 服务器先在其数据库中查找该计算机的配置信息。若找到，则返回找到的信息。若找不到，则从服务器的 IP 地址池 (address pool) 中取一个地址分配给该计算机。DHCP服务器的回答报文叫做提供报文（DHCP OFFER）。

### 具体工作流程

![[image-20221229112553495.png]]

- 需要进行网络配置的主机通过DHCP客户端以**广播**的形式发送**DHCP发送报文**（DHCP DISCOVER）
	- DHCP发现报文的内容包括：事务ID、DHCP客户端的MAC地址
	- 封装该报文的IP数据包由于没有IP，所以源IP地址使用0.0.0.0替代，目的地址为255.255.255.255广播地址（主要时由于此时主机并不知道网络内有几个DHCP服务器，也不知道对应的IP地址）
- DHCP服务器发现这些广播报文之后，根据其中封装的MAC地址来**查找数据库**，如果能查询到匹配的信息，就使用这些匹配的信息来构建并发送**DHCP提供报文**；如果没有，则采用默认配置信息构建报文发送（所分配的IP地址往往先经过ARP确保IP地址未被使用）
![[image-20221229113418271.png]]
> DHCP提供报文（DHCP OFFER）
> 事务ID：DHCP客户端收到提供报文时，会将提供报文中的事务ID与之前发送的发现报文中的事务ID进行比较，以确认此DHCP OFFER是否为自己的
> 配置信息：
> 	IP地址：DHCP服务器从自己的IP池中挑选出来的租用给主机的IP地址（ARP确保）
> 	子网掩码
> 	地址租期
> 	默认网关
> 	DNS服务器
> 由于此时主机还是没有IP，所以目的地址还是广播地址（识别主要是通过事务ID）

![[image-20221229114722840.png]]
- DHCP客户端收到DHCP OFFER之后，会选择一个DHCP服务器（一般是先收到哪个的回应用哪个）向对应的DHCP服务器发送**DHCP请求报文**（DHCP REQUEST），请求租用IP地址
> DHCP请求报文（DHCP REQUEST）
> 	事务ID
	    DHCP客户端的MAC地址
	    接收的租约中的IP地址
	    提供此租约的DHCP服务器端的IP地址
	此时的目的地址还是广播，能向所有DHCP服务器告知自己的选择，源地址还是0.0.0.0
	将自己选择的DHCP服务器的IP加入到请求报文中，DHCP服务器以此识别客户端的选择

![[image-20221229115448255.png]]
- 对应的DHCP服务器收到请求报文之后，会回传**DHCP确认报文**（DHCP ACK），表示接受请求，目的地址还是广播地址
- DHCP客户端收到确认报文之后，使用IP地址之前还会进行ARP检测
	- 若被占用，则客户端向服务器发送DHCP DECLINE报文报文撤销IP地址租约，重新发送DHCP DISCOVER报文
![[image-20221229122051274.png]]

## DHCP中继代理

![[image-20221229122134297.png]]
emmm
路由器代理DHCP服务器





