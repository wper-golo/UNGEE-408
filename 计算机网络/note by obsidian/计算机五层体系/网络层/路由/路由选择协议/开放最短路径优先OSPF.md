**开放最短路径优先（Open Shortest Path First）**
>其他协议也可能是最短路径，这个最短路径只是个名字

# 概念

- 开放最短路径优先（OSPF）是为了克服RIP距离向量的缺点而产生的
	- 开放（Open）是指该协议公开
	- 最短路径优先指的是该协议使用了**最短路径算法（SPF）**
- OSPF基于**链路状态**
- OSPF采用**SPF计算路由**，从算法上保证了不会产生路由环路
- OSPF**不限制网络规模**，更新效率高，**收敛速度快**

# OSPF

## 链路状态

链路状态指本路由器都和哪些路由器相邻，以及相应链路的“代价”(cost)。

“代价”用来表示费用、距离、时延、带宽等等，都由网络管理人员决定。

![[image-20221108084013541.png]]

## Hello分组

OSPF路由器之间通过交互**问候(Hello)分组**，建立和维护邻居关系

>IP数据报首部中协议号字段的取值应为89，来表明IP数据报的数据载荷为OSPF分组

![[image-20221108084220663.png]]

## 发送链路状态通告LSA

使用OSPF的每个路由器都会产生链路状态通告LSA(Link State Advertisement)
LSA中包含以下内容
- 直连网络的链路状态信息
- 邻居路由器的链路状态信息
![[image-20221108091745133.png]]

>洪泛法：从一个接口进来，其他接口出去

## 链路状态数据库同步

使用OSPF的每一个路由器都有一个链路状态数据库LSDB，用以存储LSA

![[image-20221108092011631.png]]

## 使用SPF算法计算出各自路由器到达其他路由器的最短路径

![[image-20221108092356806.png]]

## OSPF五种分组类型

- 问候（Hello）分组
	- 用以发现和维护邻居路由器的可达性
- 数据库描述（Database Description）分组
	- 向邻居路由器给出自己的链路状态数据库中所有链路状态项目的摘要信息
- 链路状态请求（Link State Request）分组
	- 向邻居路由器请求发送某些链路状态项目的详细信息
- 链路状态更新（Link State Update）分组
	- 路由器使用这种分组将其链路状态进行洪泛发送，即使用洪泛法对全网更新链路状态
- 链路状态确认（Link State Acknowledgment）分组
	- 这是对链路状态更新分组的确认分组

## OSPF的基本工作过程

![[image-20221108105802004.png]]

更直观的图：
![[image-20221108110540688.png]]

更详细一点：
- RouterID（用以标识唯一一台OSPF路由器，格式同IPv4）选举
	- 选择手工配置的Router ID
	- 没有手工配置Router ID，选择Loopback接口中最大的IP地址
	- 没有配置Loopback接口，选择链路接口中最大的IP地址
- 通过Hello报文，与直连的OSPF建立邻居关系
	- Hello报文用以发现邻居；通过参数进行协商，建立邻居关系；通过Keepalive机制检测邻居运行状态
	- 具体过程为：
		- 启动OSPF路由器，发送Hello报文寻找邻居，此时报文中的RouterID为自己的，neighbor为空，双方邻居的状态都为down
		- 当路由器B收到一个Hello包，其中有路由器A的RouterID且邻居为空，就会将自己的邻居状态变为Init，然后回送一个Hello包，里面的RouterID为自己的，neighbor为路由器A的RouterID
		- 路由器A收到带有neighbor信息的报文，就会将自己的邻居变为2-way，反向同理
		- 当双方的邻居都变成2-way时，邻居关系就建立完成了

## OSPF在多点接入网络中路由器邻居关系建立

如果不采用其他机制，将会产生大量多播分组

![[image-20221108152819755.png]]

>若DR出现问题，则由BDR顶替DR

## OSPF对自治区域的再划分

**为了使OSPF能够用于规模很大的网络，OSPF把一个自治系统再划分为若干个更小的范围，叫做区域（Area）**

- 某一自治系统内，所有路由器都使用OSPF协议，OSPF将该自治系统再划分成四个更小的区域
- 每个区域都由一个32位比特的区域标识符
- 主干区域的区域标识符必须为0，主干区域用于连通其他区域
- 其他区域的区域标识符不能为0且不相同
- 每个区域一般不应该包含路由器超过200个
- 划分区域的好处就是，利用洪泛法交换链路状态信息局限于每一个区域而不是自治系统，这样减少整个网络上的通信量

![[image-20221108185957362.png]]

